<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <meta name="generator" content="Doxygen 1.13.2" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>di: Bytes</title>
    <link href="tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
 <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
 <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
    <!-- ... other metadata & script includes ... -->
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeFragmentCopyButton.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeParagraphLink.init();
    </script>
  </head>
  <body>
      <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0">
            <tbody>
              <tr id="projectrow">
                <td id="projectalign">
                  <div id="projectname">
                    di<span id="projectnumber">&#160;0.1.0</span
                    >
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_docs_2pages_2bytes.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Bytes</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md23"></a></p>
<h1><a class="anchor" id="autotoc_md24"></a>
Purpose</h1>
<p>Most low-level code has to deal directly with bytes. This can be for reading and parsing various file formats, or writing data to a frame buffer or physical device. Because C++ does not have a borrow checker, these interfaces typically need to be concerned with the lifetime of the bytes they are operating on. The library aims to solve this problem by providing a generic (over storage method) byte buffer mechanism. Additionally, there are facilities to perform bit-level and byte-level IO asynchronously, while even allowing for zero-copy operations.</p>
<h1><a class="anchor" id="autotoc_md25"></a>
Byte Buffer</h1>
<p>In certain scenarios, like creating audio data, code needs to actually write directly to the backing bytes. However, most of the time, code is only interested in reading the data. These 2 different scenarios represent exclusive references and shared references respectively (in Rust). Both types of references can actually use the same type-erased backing store.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Type Erased Backing Store</h2>
<p>Any class which aims to represent a series of contiguous bytes can be represented using only 2 member variables:</p>
<ol type="1">
<li><code>byte*</code> data</li>
<li><code>usize</code> size</li>
</ol>
<p>Unlike a normal type-erased class, where we would need to perform a indirect (virtual) call in order to access the concrete type, we can instead store these member variables directly (as a <code><a class="el" href="classdi_1_1Span.html">di::Span</a></code>) on object construction. This means that the only member variable which needs to be type-erased are the special member functions. As a further optimization, we can require the backing store be trivially relocatable to allow move construction to not require an indirect call.</p>
<p>The backing store now looks something like this:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>AnyBytesStorage {</div>
<div class="line">    <a class="code hl_typedef" href="namespacedi_1_1any.html#aa9fa9d2ffdd46bcf50f8da98678b10d3">di::Any</a>&lt;<span class="comment">/* ... */</span>&gt; object;</div>
<div class="line">    <a class="code hl_class" href="classdi_1_1vocab_1_1Span.html">di::Span&lt;byte&gt;</a> data;</div>
<div class="line">};</div>
<div class="ttc" id="aclassdi_1_1vocab_1_1Span_html"><div class="ttname"><a href="classdi_1_1vocab_1_1Span.html">di::vocab::Span</a></div><div class="ttdef"><b>Definition</b> span_forward_declaration.h:10</div></div>
<div class="ttc" id="anamespacedi_1_1any_html_aa9fa9d2ffdd46bcf50f8da98678b10d3"><div class="ttname"><a href="namespacedi_1_1any.html#aa9fa9d2ffdd46bcf50f8da98678b10d3">di::any::Any</a></div><div class="ttdeci">meta::Type&lt; AnyT&lt; UserInterface, Storage, VTablePolicy &gt; &gt; Any</div><div class="ttdef"><b>Definition</b> any.h:302</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md27"></a>
Shared Ownership</h2>
<p>Shared ownership requires not giving mutable access to the underlying bytes (we should return a <code>byte const*</code> for the data). This is to prevent data races. The underlying backing memory can either be reference-counted or statically allocated, since the backing object is type-erased. Similarly, the object's destructor can do anything, such as calling <code>operator delete[]</code>, <code>munmap</code>, <code>smh_unlink</code>, and so on. This enables zero-copy de-serialization.</p>
<p>For instance, a parser for the WAV file format usually doesn't have to do much. This file format essentially just stores raw audio samples on disk (in most cases). Rather than copying the data into our own audio buffer, we can now directly reference the file's memory in a safe way, by references a backing store which will eventually call <code>munmap()</code>.</p>
<p>A key reason this is possible is that we can shrink the shared bye buffer at any time, while still keeping a reference to the original object. This is because the actual span of bytes is separate from the underlying object. This ability is similar to <code>std::shared_ptr</code>.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Unique Ownership</h2>
<p>A unique byte buffer can use the same backing store as the shared variant, but will allow getting a mutable reference to the underlying bytes. The key point here is that once we have wrote data into the buffer, we can then safely share the data by converting ourselves into a shared reference. This conversion only works 1 way, it is not safe to convert a shared reference into an owning one. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="md_docs_2pages_2library__component__overview.html">Library Component Overview</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
